name: Deploy Aliyun oss

# Controls when the workflow will run
on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

  workflow_dispatch:

jobs:
  checkout:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

  build:
    runs-on: ubuntu-latest
    needs: checkout
    steps:
      - name: Build Jekyll Pages
        uses: vivi90/jekyll-minimal-action@v1.1.0
        with:
          command: jekyll build --trace --baseurl /plugins

  deploy-aliyun-oss-canary:
    runs-on: ubuntu-latest
    if: ${{ github.ref != 'refs/heads/master' }}
    needs: build
    steps:
      - name: Upload Canary
        uses: yinlinyang/ali-oss-utils@v0.1.1
        with:
          key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          region: oss-cn-hongkong
          bucket: inpageedit-dev
          asset-path: ./_site
          target-path: /plugins/${{ github.ref_name }}

  deploy-aliyun-oss-prod:
    runs-on: ubuntu-latest
    if: ${{ github.ref == 'refs/heads/master' }}
    needs: build
    steps:
      - name: Upload Canary
        uses: tvrcgo/upload-to-oss@v0.1.1
        with:
          key-id: ${{ secrets.ALIYUN_ACCESS_KEY_ID }}
          key-secret: ${{ secrets.ALIYUN_ACCESS_KEY_SECRET }}
          region: oss-cn-hongkong
          bucket: inpageedit-prod
          asset-path: ./_site
          target-path: /plugins
